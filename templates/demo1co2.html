<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Household Carbon Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0f766e;
      --accent-2: #06b6d4;
      --radius: 14px;
      font-family: Inter, ui-sans-serif, system-ui;
    }

    body{
      margin:0;
      background: linear-gradient(180deg,var(--bg),#eef2f7);
      padding:24px;
      display:flex;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:1100px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:20px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 6px 20px rgba(15,23,42,0.06);
      padding:18px;
    }

    h1{margin:0}

    button{
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      border:none;
    }

    .btn-primary{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:white;
    }

    .btn-outline{
      background:white;
      border:1px solid #e5e7eb;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:15px;
      flex-wrap:wrap;
    }

    canvas{ width:100% !important; height:260px !important; }
  </style>
</head>

<body>
<div class="container">

<section class="card">
<h1>Household Carbon Tracker</h1>

<form onsubmit="event.preventDefault(); localCalculate();">

<label>Household Name</label>
<input id="householdName" type="text">

<label>Household Size</label>
<input id="householdSize" type="number" value="1" min="1">

<label>Electricity (kWh)</label>
<input id="electricity_kwh" type="number">

<label>LPG Cylinders</label>
<input id="lpg_cylinders" type="number">

<label>Distance (km)</label>
<input id="distance_km" type="number">

<label>Waste (kg)</label>
<input id="waste_kg" type="number">

<label>Recycling (%)</label>
<input id="recycle_pct" type="number" value="0" min="0" max="100">

<div class="actions">
  <button class="btn-primary" type="submit">Calculate (Local)</button>
  <button class="btn-outline" type="button" onclick="sendToAPI()">Send to API</button>
  <a href="/records">
    <button type="button" class="btn-outline">View Records</button>
  </a>
</div>

</form>

<div id="results" style="margin-top:20px;"></div>
</section>

<aside class="card">
<canvas id="breakdownChart"></canvas>
</aside>

</div>

<script>

const ELECTRICITY_FACTOR = 0.82;
const LPG_FACTOR = 42.5;
const TRANSPORT_FACTOR = 0.2;
const WASTE_FACTOR = 1.8;

const ctx = document.getElementById('breakdownChart').getContext('2d');
let chart = new Chart(ctx, {
  type: 'pie',
  data: {
    labels: ['Electricity','LPG','Transport','Waste'],
    datasets: [{ data:[0,0,0,0] }]
  }
});

function localCalculate(){

  const size = parseInt(document.getElementById("householdSize").value || 1);
  const electricity = parseFloat(document.getElementById("electricity_kwh").value || 0);
  const lpg = parseFloat(document.getElementById("lpg_cylinders").value || 0);
  const distance = parseFloat(document.getElementById("distance_km").value || 0);
  const waste = parseFloat(document.getElementById("waste_kg").value || 0);
  const recycle = parseFloat(document.getElementById("recycle_pct").value || 0);

  const electricity_co2 = electricity * ELECTRICITY_FACTOR;
  const lpg_co2 = lpg * LPG_FACTOR;
  const transport_co2 = distance * TRANSPORT_FACTOR;
  const waste_co2 = (waste * WASTE_FACTOR) * (1 - recycle/100);

  const total = electricity_co2 + lpg_co2 + transport_co2 + waste_co2;

  document.getElementById("results").innerHTML =
    `<strong>Total Monthly CO₂:</strong> ${total.toFixed(2)} kg`;

  chart.data.datasets[0].data = [
    electricity_co2,
    lpg_co2,
    transport_co2,
    waste_co2
  ];
  chart.update();
}

/* ✅ PROPER SEND TO API FUNCTION */
async function sendToAPI(){

  const payload = {
    household_name: document.getElementById('householdName').value || "",
    household_size: parseInt(document.getElementById('householdSize').value || 1),
    electricity_kwh: parseFloat(document.getElementById('electricity_kwh').value || 0),
    lpg_cylinders: parseFloat(document.getElementById('lpg_cylinders').value || 0),
    distance_km: parseFloat(document.getElementById('distance_km').value || 0),
    waste_kg: parseFloat(document.getElementById('waste_kg').value || 0),
    recycle_pct: parseFloat(document.getElementById('recycle_pct').value || 0)
  };

  try {
    const response = await fetch("/calculate", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    await response.json();
    alert("✅ Data saved successfully!");

  } catch(err){
    alert("❌ Error sending data");
  }
}

</script>

</body>
</html>
